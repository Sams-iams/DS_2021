---
title: "Results Stat Analysis"
author: "Lucy and Sammie"
date: "25/11/2021"
output: pdf_document
---

Load libraries:
```{r, include=FALSE}
library(ggplot2)
library(popbio)
library(dplyr)
library(patchwork)
library(DHARMa)
library(mgcv)
library(fitdistrplus)
library(goft)
library(gamlss)
library(viridis)
library(tidyverse)
library(patchwork)
```

Load in data and rename PAM column:
```{r}
data <- read.csv("test_data_NOV25.csv")
data <- data %>%
rename("Y_II_PAM" = "Y_II..PAM.") 
```

Setting up data with PAM columns only:
```{r}
data_to_model <- data %>%
  unite(id, species, species_card, sep = '_', remove = F) %>%
  dplyr::select("date","yellow_tub","species_card","species","number","treatment","name","event","Y_II_PAM","id") %>%
  mutate(id = as.factor(id))
```

re-ordering event for graphing later:
```{r}
data_to_model <- data_to_model %>% mutate(event = fct_relevel(event, "pre_stress", "post_stress", "post_stress_1", "post_stress_2", "post_stress_3", "post_stress_4", "post_stress_5", "post_stress_6","post_stress_7"))
```

testing for normality:
```{r}
shapiro.test(data_to_model$Y_II_PAM)

#not normal P=3.09e-08
```

Cullen & Frey graph:
```{r}
descdist(data_to_model$Y_II_PAM)
```
Looks like it might be a gamma/lognormal/weibull

Look at histograms to find distribution:
```{r}
mGA <- histDist(data_to_model$Y_II_PAM, "GA", density = T, main = "Gamma")
mlN <- histDist(data_to_model$Y_II_PAM, "LOGNO", density = T, main = "lNorm")
mWE <- histDist(data_to_model$Y_II_PAM, "WEI", density = T, main = "Weibull")
mNO <- histDist(data_to_model$Y_II_PAM, "NO", density = T, main = "Normal")
```
```{r}
GAIC(mGA, mlN, mWE, mNO, mSEP2)
#these give us negative values, which fit is best????
```


```{r}
fitDist(Y_II_PAM, data = data_to_model, type = "realAll", try.gamlss = T)
```

Trying skewed exponential power type 2:
```{r}
mSEP2 <- histDist(data_to_model$Y_II_PAM, "SEP2", density = T, main = "SEP2")
```
Decided to move forward exploring SEP2 and WEI distributions:
```{r}
mod_SEP2 <- gamlssML(Y_II_PAM ~ species + treatment*event + random(id), family = SEP2(), data = data_to_model, method = nlminb())

summary(mod_SEP2)
```
Model using WEI-
```{r}
mod_WEI <- gamlss(Y_II_PAM ~ species + treatment*event + random(id), family = WEI(), data = data_to_model, method = RS(), control = gamlss.control())

summary(mod_WEI)
```

Line-range plot--
```{r}

```

Sammie's test of colour dataframe and cleaning
```{r}
write.csv(data_to_model,"id_data.csv")


c_data <- read.csv("test_colour.csv") %>%
  dplyr::filter(event == "pre_stress" | event == "post_stress_7") %>%
   mutate(id = as.factor(id)) %>%
  dplyr::select("id", "int_mean", "treatment", "species", "event")%>%
mutate(treatment = fct_relevel(treatment, "control", "low", "mid", "high")) %>%
   mutate(species = fct_relevel(species, "cham", "calli ","chillensis")) %>%
  na.omit(id, int_mean, species, treatment,event)
  

ct_data <- read.csv("test_colour.csv") %>%
  mutate(id = as.factor(id)) %>%
  dplyr::select("id", "change_g7", "change_r7", "species", "treatment") %>%
  na.omit(id, change_g7, change_r7, species, treatment) %>%
  mutate(treatment = fct_relevel(treatment, "control", "low", "mid", "high")) %>%
   mutate(species = fct_relevel(species, "cham", "calli ","chillensis"))
  
  
  
```

filter for species
```{r}
cham_ctdata <- ct_data %>%
  mutate(treatment = fct_relevel(treatment, "control", "low", "mid", "high")) %>%
  dplyr::filter(species == "cham") 

ca_ctdata <- ct_data %>%
  mutate(treatment = fct_relevel(treatment, "control", "low", "mid", "high")) %>%
  dplyr::filter(species == "calli ")

chil_ctdata <- ct_data %>%
  mutate(treatment = fct_relevel(treatment, "control", "low", "mid", "high")) %>%
  dplyr::filter(species == "chillensis")
```


Normality test for colour data
```{r}
shapiro.test(ct_data$change_g7)
```
The colour data is not normal 


Collen & Frey Graph of colour data
```{r}
descdist(ct_data$change_g7)



```
From the Collen and Frey graph we will try gamma, weibull, lognormal, and a beta 
Looking at other distribution fits
```{r}
fitDist(change_g7, data = ct_data, type = "realAll", try.gamlss = T)

```
We will also try reverse gumbel to see which out of all the suggested test has the lowest AIC 


Look at histograms to find distribution: 
```{r}
cmGA <- histDist(ct_data$change_g7, "GA", density = T, main = "Gamma")
cmlN <- histDist(ct_data$change_g7, "LOGNO", density = T, main = "lNorm")
cmWE <- histDist(ct_data$change_g7, "WEI", density = T, main = "Weibull")
cmB <- histDist(ct_data$change_g7, "BE", density = T, main = "Beta")
cRG <- histDist(ct_data$change_g7, "RG", density = T, main = "Reverse Gumbel")
cNO <- histDist(ct_data$change_g7, "NO", density = T, main = "Normal")
```
Found out that some of the models do not work due to negative values possibly and will continue AIC using reverse gumbell


AIC 
```{r}
GAIC(cRG,cNO)
```

Lowest AIC is Reverse gumbell so we will begin modelling!

```{r}
cmRG <- histDist(ct_data$change_g7, "RG", density = T, main = "Reverse Gumbel")
```

Making a model!
```{r}
mod_RG <- gamlss(change_g7 ~ species + treatment + random(id), family = RG(), data = ct_data)

summary(mod_RG)
```

Comparing the means for significance 
```{r}

library(FSA) 
library(fGarch)
library(LambertW)

kruskal.test(change_g7 ~ treatment, data = ct_data)

kruskal.test(change_g7 ~ treatment, data = cham_ctdata)
dunnTest(change_g7 ~ treatment, data = cham_ctdata)

kruskal.test(change_g7 ~ treatment, data = ca_ctdata)
dunnTest(change_g7 ~ treatment, data = ca_ctdata)

kruskal.test(change_g7 ~ treatment, data = chil_ctdata)
dunnTest(change_g7 ~ treatment, data = chil_ctdata)
```

no siginificance found, though potentially for chilensis


Boxplot for colour data
```{r}
cham_ctgplot <- ggplot(cham_ctdata, aes(x= treatment, y = change_g7, fill = treatment)) +
  geom_boxplot() + 
  ylab("Change in grey scale brightness") +
  xlab("Treatment") +
  ggtitle("Chamberlainium") +
  theme_bw()

cham_ctrplot <- ggplot(cham_ctdata, aes(x= treatment, y = change_r7, fill = treatment)) +
  geom_boxplot() + 
  ylab("Change in red scale brightness") +
  xlab("Treatment") +
  ggtitle("Chamberlainium") +
  theme_bw()

cham_ctgplot + cham_ctrplot

ca_ctgplot <- ggplot(ca_ctdata, aes(x= treatment, y = change_g7, fill = treatment)) +
  geom_boxplot() + 
  ylab("Change in grey scale brightness") +
  xlab("Treatment") +
  ggtitle("Calliarthron") +
  theme_bw()

ca_ctrplot <- ggplot(ca_ctdata, aes(x= treatment, y = change_r7, fill = treatment)) +
  geom_boxplot() + 
  ylab("Change in red scale brightness") +
  xlab("Treatment") +
  ggtitle("Calliarthron") +
  theme_bw()

ca_ctgplot + ca_ctrplot

chil_ctgplot <- ggplot(chil_ctdata, aes(x= treatment, y = change_g7, fill = treatment)) +
  geom_boxplot() + 
  ylab("Change in grey scale brightness") +
  xlab("Treatment") +
  ggtitle("Chilensis") +
  theme_bw()

chil_ctrplot <- ggplot(chil_ctdata, aes(x= treatment, y = change_r7, fill = treatment)) +
  geom_boxplot() + 
  ylab("Change in red scale brightness") +
  xlab("Treatment") +
  ggtitle("Chilensis") +
  theme_bw()

chil_ctgplot + chil_ctrplot

```

Decision making on colour data 

```{r}
#useful code

#mutate(treatment = fct_relevel(treatment, "control", "low", "mid", "high"))
#L_ch_plot <- ggplot(ch1_data, aes(x= event, y = Y_II_PAM, fill = treatment)) +
#  ylab("Photoefficiency (\u0394 F/Fm)") +
#  xlab("Event") +
#  labs(fill = "Treatment")+
#  scale_x_discrete(labels = c('Pre-stress','Day 1 Post-stress','Day 4 Post-stress')) + 
#  theme_classic() +
#  ggtitle("Chamberlanium tumidum") + 
#  scale_fill_manual(values = c('#3C507BFF', '#18DBC5FF', '#F7C13AFF', '#B11901FF'), labels = c("Control", "Low", "Mid", #"High")) + 
#  scale_colour_manual(values = c('#3C507BFF', '#18DBC5FF', '#F7C13AFF', '#B11901FF'))
```


scrap the red scale and keep the grey scale since they both show similar results 
```{r}
cham_ctgplot <- ggplot(cham_ctdata, aes(x= treatment, y = change_g7, fill = treatment)) +
  geom_boxplot() + 
  guides(fill = FALSE) +
  ylab("Change in mean intensity") +
  xlab("H202 Concentration") +
  scale_x_discrete(labels = c('Control','Low','Mid','High')) + 
   ylim(-15,30) +
  ggtitle("A) C. tumidum") +
  scale_fill_manual(values = c('#3C507BFF', '#18DBC5FF', '#F7C13AFF', '#B11901FF'), labels = c("Control", "Low", "Mid", "High")) +
  theme_classic()

ca_ctgplot <- ggplot(ca_ctdata, aes(x= treatment, y = change_g7, fill = treatment)) +
  geom_boxplot() + 
  guides(fill = FALSE) +
  ylab("") +
 xlab("H202 Concentration") +
  labs(fill = "H202 Concentration") +
  scale_x_discrete(labels = c('Control','Low','Mid','High')) + 
   ylim(-15,30) +
  ggtitle("B) C. tuberculosum") +
  scale_fill_manual(values = c('#3C507BFF', '#18DBC5FF', '#F7C13AFF', '#B11901FF'), labels = c("Control", "Low", "Mid", "High")) +
  theme_classic()

chil_ctgplot <- ggplot(chil_ctdata, aes(x= treatment, y = change_g7, fill = treatment)) +
  geom_boxplot() + 
  ylab("") +
 xlab("H202 Concentration") +
  labs(fill = "H202 Concentration") +
  scale_x_discrete(labels = c('Control','Low','Mid','High')) + 
 ylim(-15,30) +
  ggtitle("C) C. chilensis") +
  scale_fill_manual(values = c('#3C507BFF', '#18DBC5FF', '#F7C13AFF', '#B11901FF'), labels = c("Control", "Low", "Mid", "High")) +
  theme_classic()

colour_fig1 <- cham_ctgplot + ca_ctgplot + chil_ctgplot 

ggsave(colour_fig1, filename = "colour_figure1.jpg", width = 13, height = 10)

```

Sammie testing cleaning of plots
```{r}


species_names <- list(
  'cham'="A) C. tumidum",
  'calli '="B) C. tuberculosum",
  'chillensis'="C) C. chilensis"
)

species_labeller <- function(variable,value){
  return(species_names[value])
}


test_ctgplot <- ggplot(ct_data, aes(x= treatment, y = change_g7, fill = treatment)) +
  geom_boxplot() + 
  ylab("Change in mean intensity") +
  xlab("H2O2 Concentration") + 
  labs(fill = "H2O2 Concentration") +
  facet_grid(. ~ species, labeller=species_labeller) +
  scale_x_discrete(labels = c('Control','Low','Mid','High')) +
  scale_fill_manual(values = c('#3C507BFF', '#18DBC5FF', '#F7C13AFF', '#B11901FF'), labels = c("Control", "Low", "Mid", "High")) +
theme (panel.background = element_rect(fill = NA, color = "black"),strip.text.x = element_text(size = 20, face = "italic"),legend.key.size = unit(2, 'cm'), axis.text.x = element_text(size = 15, angle=90, hjust=0.5), axis.title.x = element_text(size = 25), axis.title.y = element_text(size = 25), legend.text = element_text(size = 14), legend.title = element_text(size = 20), axis.text.y = element_text(size = 20))
                                                                                                                                                                                                                                                                                                                                                                                                                5))

test_ctgplot

ggsave(test_ctgplot, filename = "colour_figure1facet.jpg", width = 15, height = 10)

```

subsetting data to compare significance between species 
```{r}
high_ctdata <- ct_data %>%
  dplyr::filter(treatment == "high")

mid_ctdata <- ct_data %>%
  dplyr::filter(treatment == "mid") 

low_ctdata <- ct_data %>%
  dplyr::filter(treatment == "low") 
control_ctdata <- ct_data %>%
  dplyr::filter(treatment == "control") 

```


testing between species for colour 
```{r}
kruskal.test(change_g7 ~ species, data = ct_data)
dunnTest(change_g7 ~ species, data = ct_data)
  
kruskal.test(change_g7 ~ species, data = control_ctdata)
dunnTest(change_g7 ~ species, data = control_ctdata)

kruskal.test(change_g7 ~ species, data = low_ctdata)
dunnTest(change_g7 ~ species, data = low_ctdata)

kruskal.test(change_g7 ~ species, data = mid_ctdata)
dunnTest(change_g7 ~ species, data = mid_ctdata)

kruskal.test(change_g7 ~ species, data = high_ctdata)
dunnTest(change_g7 ~ species, data = high_ctdata)
```
All species comparisons at each treatment level are significant when compared to chamberlainium



ˆComparing species figures
```{r}

colour_high_plot<- ggplot(high_ctdata, aes(x= species, y= change_g7 ,fill = species)) +
  geom_boxplot()
  
colour_mid_plot <- ggplot(mid_ctdata, aes(x= species, y= change_g7 ,fill = species)) +
  geom_boxplot()

colour_low_plot <- ggplot(low_ctdata, aes(x= species, y= change_g7 ,fill = species)) +
  geom_boxplot()

colour_control_plot <- ggplot(control_ctdata, aes(x= species, y= change_g7 ,fill = species)) +
  geom_boxplot()

(colour_control_plot + colour_low_plot) / (colour_mid_plot + colour_high_plot)

```

```{r}
treatment_names <- list(
  'control'="A) Control",
  'low'="B) Low",
  'mid'="C) Mid",
  'high' ="D) High"
)

treatment_labeller <- function(variable,value){
  return(treatment_names[value])
}


tester_colour_plot <- ggplot(ct_data, aes(x= species, y= change_g7, fill= species)) +
    ylab("Change in mean intensity") +
  xlab("Species") + 
  labs(fill = "Species") + 
  facet_grid(. ~ treatment, labeller = treatment_labeller) +
  scale_x_discrete(labels = c('C. tumidum','C. tuberculosum','C. chilensis')) +
  geom_boxplot() +
  ylab("Change in mean intensity") +
  xlab("Species") + 
  labs(fill = "Species") + 
  scale_fill_manual(values = c('dark magenta', '#E7298A', 'darkorange1'), labels = c('C. tumidum','C. tuberculosum','C. chilensis')) +
theme (panel.background = element_rect(fill = NA, color = "black"),strip.text.x = element_text(size = 20), legend.key.size = unit(2, 'cm'), axis.text.x = element_text(size = 20, angle=90, hjust=0.5, face = "italic"), axis.title.x = element_text(size = 30), axis.title.y = element_text(size = 30), legend.text = element_text(size = 14, face = "italic"), legend.title = element_text(size = 20), axis.text.y = element_text(size = 20), )


tester_colour_plot

ggsave(tester_colour_plot, filename = "colour_figure2.png", height = 10, width = 15)

```

Intensity with the means stuff 
```{r}
int_chil <- c_data %>%
  dplyr::filter(species == "chillensis")

int_ca <- c_data %>%
  dplyr::filter(species == "calli ")

int_cham <- c_data %>%
  dplyr::filter(species == "cham")

int_chil_plot <- ggplot(int_chil, aes(x=event, y=int_mean, fill = treatment)) +
  geom_boxplot() +
  ggtitle("") +
  xlab("event") +
  ylab("int_mean") +
  theme_classic() +
  scale_x_discrete(labels=c("Pre-stress", "Day 7"))

int_ca_plot <- ggplot(int_ca, aes(x=event, y=int_mean, fill = treatment)) +
  geom_boxplot() +
  ggtitle("") +
  xlab("event") +
  ylab("int_mean") +
  theme_classic() +
  scale_x_discrete(labels=c("Pre-stress", "Day 7"))

int_cham_plot <- ggplot(int_cham, aes(x=event, y=int_mean, fill = treatment)) +
  geom_boxplot() +
  ggtitle("") +
  xlab("event") +
  ylab("int_mean") +
  theme_classic() +
  scale_x_discrete(labels=c("Pre-stress", "Day 7"))

int_chil_plot
int_ca_plot
int_cham_plot


kruskal.test(int_mean ~ treatment, data = c_data)
dunnTest(int_mean ~ treatment, data = int_chil)
```






